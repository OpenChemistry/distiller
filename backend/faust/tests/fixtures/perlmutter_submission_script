#!/bin/bash
#      _ _     _   _ _ _
#     | (_)   | | (_) | |
#   __| |_ ___| |_ _| | | ___ _ __
#  / _` | / __| __| | | |/ _ \ '__|
# | (_| | \__ \ |_| | | |  __/ |
#  \__,_|_|___/\__|_|_|_|\___|_|
#
# Generated by distiller
#
#SBATCH --qos=science
#SBATCH --constraint=gpu
#SBATCH --nodes=8
#SBATCH --time=00:30:00
#SBATCH --job-name=distiller-count-0
#SBATCH --exclusive
#SBATCH --account=staff
#SBATCH --chdir=/tmp/jobs/0
#SBATCH --image=openchemistry/stempy:multi-mpi

export HDF5_USE_FILE_LOCKING=FALSE

error_exit()
{
  echo "$1" 1>&2
  exit 1
}

list_files() {
  local host=$1
  local path=$2

  data_files=($(ssh changeme@$host ls $path/data_scan0*01_module*.data || error_exit "Error listing files: $host:$path."))
  number_of_files=${#data_files[@]}
  for ((i=0;i<$number_of_files;i++)); do
    echo "changeme@$host:${data_files[$i]}" >> _ncem_files_0_$((i%8)).txt
  done
}

list_files localhost /mnt/nvmedata1
list_files localhost /mnt/nvmedata4
list_files localhost /mnt/nvmedata5

srun -n 8 --cpus-per-task=2 --ntasks-per-node=1 --cpu-bind=cores bbcp.sh  || error_exit "Error bbcp srun command failed."

rm _ncem_files_0_*.txt

# Remove any // ($DW_JOB_STRIPED has a trailing slash)
BBCP_DEST_DIR=`echo "$PSCRATCH/ncem/0" |  sed 's/\/\//\//g'`

srun --exclusive -c 128 -n 8 shifter python3 /script --pad -l $BBCP_DEST_DIR -t 4.0 -s 1 --multi-pass || error_exit "Error shifter execution failed."

cp ${BBCP_DEST_DIR}/data_scan*.h5  /tmp/data_scan1_id0_th4.0_electrons.h5 || error_exit "Failed to copy counted data to ncemhub."
# Clean up
rm -rf $PSCRATCH/ncem/0